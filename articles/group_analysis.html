<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title> • fmrireg</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmrireg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><h6 class="dropdown-header" data-toc-skip>Getting Started</h6></li>
    <li><a class="dropdown-item" href="../articles/Overview.html">Package Overview</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced Topics</h6></li>
    <li><a class="dropdown-item" href="../articles/a_05_contrasts.html">Contrasts</a></li>
    <li><a class="dropdown-item" href="../articles/a_08_simulation.html">Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/a_09_linear_model.html">Linear Modeling</a></li>
    <li><a class="dropdown-item" href="../articles/sketched-ar.html">Sketched GLM (SRHT/IHS + Nyström)</a></li>
    <li><a class="dropdown-item" href="../articles/a_10_dataset.html">Dataset Management</a></li>
    <li><a class="dropdown-item" href="../articles/group_analysis.html">Group Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/functional_connectivity.html">Functional Connectivity</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Resources</h6></li>
    <li><a class="dropdown-item" href="../articles/benchmark_datasets.html">Benchmark Datasets</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/bbuchsbaum/fmrireg/releases/tag/v0.1.0">Version 0.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbuchsbaum/fmrireg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1></h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bbuchsbaum/fmrireg/blob/master/vignettes/group_analysis.Rmd" class="external-link"><code>vignettes/group_analysis.Rmd</code></a></small>
      <div class="d-none name"><code>group_analysis.Rmd</code></div>
    </div>

    
    
<p>title: “07. Group Analysis” author: “Bradley R. Buchsbaum” date:
“2025-09-13” output: rmarkdown::html_vignette vignette: &gt; % % % —</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrireg/">fmrireg</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette walks through a compact, end‑to‑end example of group
analysis with fmrireg. We first construct a small ROI‑level dataset to
illustrate the basic meta‑regression interface, and then move to a
voxelwise example using tiny synthetic NIfTI files. Along the way we
show how to compare groups with fixed‑ and random‑effects meta‑analysis,
how to obtain exact contrasts either at fit‑time or post‑hoc by saving
covariance, and how to perform group inference from t‑maps alone using
Stouffer, Fisher, or Lancaster combinations. The same interface scales
to full HDF5/NIfTI workflows created by <code><a href="../reference/write_results.html">write_results()</a></code> and
loaded via <code>group_data(format = "h5"|"nifti")</code>.</p>
</div>
<div class="section level2">
<h2 id="create-a-small-roi-dataset">Create a small ROI dataset<a class="anchor" aria-label="anchor" href="#create-a-small-roi-dataset"></a>
</h2>
<p>We simulate 10 subjects across two groups (A/B) for a single ROI.
Group B has an effect that is 1 unit larger than group A. All subjects
have the same SE for clarity.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_per_group</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">subjects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"s%02d"</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n_per_group</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n_per_group</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># True effects: A = 0.5, B = 1.5 (difference = 1.0)</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="st">"A"</span>, <span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">roi_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  subject <span class="op">=</span> <span class="va">subjects</span>,</span>
<span>  roi <span class="op">=</span> <span class="st">"ExampleROI"</span>,</span>
<span>  beta <span class="op">=</span> <span class="va">beta</span>,</span>
<span>  se <span class="op">=</span> <span class="va">se</span>,</span>
<span>  group <span class="op">=</span> <span class="va">group</span>,</span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build group dataset (CSV/ROI format)</span></span>
<span><span class="va">gd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group_data_from_csv.html">group_data_from_csv</a></span><span class="op">(</span></span>
<span>  <span class="va">roi_df</span>,</span>
<span>  effect_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="st">"beta"</span>, se <span class="op">=</span> <span class="st">"se"</span><span class="op">)</span>,</span>
<span>  subject_col <span class="op">=</span> <span class="st">"subject"</span>,</span>
<span>  roi_col <span class="op">=</span> <span class="st">"roi"</span>,</span>
<span>  covariate_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"group"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gd</span></span>
<span><span class="co">#&gt; Group Data Object</span></span>
<span><span class="co">#&gt; Format: csv </span></span>
<span><span class="co">#&gt; Subjects: 10 </span></span>
<span><span class="co">#&gt; Covariates: group</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fit-group-meta-analysis">Fit group meta-analysis<a class="anchor" aria-label="anchor" href="#fit-group-meta-analysis"></a>
</h2>
<p>We first fit an intercept-only model, then a model including a group
term.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Intercept-only (grand mean across subjects)</span></span>
<span><span class="va">fit_fe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, method <span class="op">=</span> <span class="st">"fe"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Intercept + group term (difference-coding for group B relative to A)</span></span>
<span><span class="va">fit_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">group</span>, method <span class="op">=</span> <span class="st">"fe"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit_cov</span><span class="op">)</span></span>
<span><span class="co">#&gt; fMRI Meta-Analysis Results</span></span>
<span><span class="co">#&gt; ==========================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: fe </span></span>
<span><span class="co">#&gt; Robust: none </span></span>
<span><span class="co">#&gt; Formula: ~1 + group </span></span>
<span><span class="co">#&gt; Subjects: 10 </span></span>
<span><span class="co">#&gt; ROIs analyzed: 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Heterogeneity:</span></span>
<span><span class="co">#&gt;   Mean tau^2: 0 </span></span>
<span><span class="co">#&gt;   Mean I^2: NaN %</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_cov</span><span class="op">)</span></span>
<span><span class="co">#&gt; fMRI Meta-Analysis Summary</span></span>
<span><span class="co">#&gt; ==========================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; fMRI Meta-Analysis Results</span></span>
<span><span class="co">#&gt; ==========================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: fe </span></span>
<span><span class="co">#&gt; Robust: none </span></span>
<span><span class="co">#&gt; Formula: ~1 + group </span></span>
<span><span class="co">#&gt; Subjects: 10 </span></span>
<span><span class="co">#&gt; ROIs analyzed: 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Heterogeneity:</span></span>
<span><span class="co">#&gt;   Mean tau^2: 0 </span></span>
<span><span class="co">#&gt;   Mean I^2: NaN %</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;   (Intercept):</span></span>
<span><span class="co">#&gt;     Mean effect: 0.5 </span></span>
<span><span class="co">#&gt;     Mean SE: 0.1118034 </span></span>
<span><span class="co">#&gt;     Significant:1/1 (100%)</span></span>
<span><span class="co">#&gt;   groupB:</span></span>
<span><span class="co">#&gt;     Mean effect: 1 </span></span>
<span><span class="co">#&gt;     Mean SE: 0.1581139 </span></span>
<span><span class="co">#&gt;     Significant:1/1 (100%)</span></span></code></pre></div>
<p>Note: With equal SE per subject, fixed-effects and random-effects
will yield similar point estimates. Random-effects
(<code>method = "pm"</code>) will estimate between- subject
heterogeneity (<code>tau2</code>) when present.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">group</span>, method <span class="op">=</span> <span class="st">"pm"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_pm</span><span class="op">)</span></span>
<span><span class="co">#&gt; fMRI Meta-Analysis Summary</span></span>
<span><span class="co">#&gt; ==========================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; fMRI Meta-Analysis Results</span></span>
<span><span class="co">#&gt; ==========================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: pm </span></span>
<span><span class="co">#&gt; Robust: none </span></span>
<span><span class="co">#&gt; Formula: ~1 + group </span></span>
<span><span class="co">#&gt; Subjects: 10 </span></span>
<span><span class="co">#&gt; ROIs analyzed: 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Heterogeneity:</span></span>
<span><span class="co">#&gt;   Mean tau^2: 0 </span></span>
<span><span class="co">#&gt;   Mean I^2: NaN %</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;   (Intercept):</span></span>
<span><span class="co">#&gt;     Mean effect: 0.5 </span></span>
<span><span class="co">#&gt;     Mean SE: 0.1118034 </span></span>
<span><span class="co">#&gt;     Significant:1/1 (100%)</span></span>
<span><span class="co">#&gt;   groupB:</span></span>
<span><span class="co">#&gt;     Mean effect: 1 </span></span>
<span><span class="co">#&gt;     Mean SE: 0.1581139 </span></span>
<span><span class="co">#&gt;     Significant:1/1 (100%)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="extract-coefficients-and-a-contrast">Extract coefficients and a contrast<a class="anchor" aria-label="anchor" href="#extract-coefficients-and-a-contrast"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coef_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fit_cov</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span></span>
<span><span class="va">coef_names</span></span>
<span><span class="co">#&gt; [1] "(Intercept)" "groupB"</span></span>
<span></span>
<span><span class="co"># Intercept should be near 0.5, the group coefficient near 1.0</span></span>
<span><span class="va">coef_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fit_cov</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">coef_est</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">coef_names</span></span>
<span><span class="va">coef_est</span></span>
<span><span class="co">#&gt; (Intercept)      groupB </span></span>
<span><span class="co">#&gt;         0.5         1.0</span></span>
<span></span>
<span><span class="co"># Build a simple contrast on the group term (if present)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"group"</span>, <span class="va">coef_names</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create a named weight vector that picks out the group coefficient</span></span>
<span>  <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">coef_names</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">coef_names</span></span>
<span>  <span class="va">w</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"group"</span>, <span class="va">coef_names</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/contrast.html">contrast</a></span><span class="op">(</span><span class="va">fit_cov</span>, <span class="va">w</span><span class="op">)</span></span>
<span>  <span class="va">con</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; $estimate</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $se</span></span>
<span><span class="co">#&gt; [1] 0.1581139</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $z</span></span>
<span><span class="co">#&gt; [1] 6.324555</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $p</span></span>
<span><span class="co">#&gt;                    [,1]</span></span>
<span><span class="co">#&gt; ExampleROI 2.539629e-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $weights</span></span>
<span><span class="co">#&gt; (Intercept)      groupB </span></span>
<span><span class="co">#&gt;           0           1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $name</span></span>
<span><span class="co">#&gt; [1] "groupB"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $parent</span></span>
<span><span class="co">#&gt; fMRI Meta-Analysis Results</span></span>
<span><span class="co">#&gt; ==========================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: fe </span></span>
<span><span class="co">#&gt; Robust: none </span></span>
<span><span class="co">#&gt; Formula: ~1 + group </span></span>
<span><span class="co">#&gt; Subjects: 10 </span></span>
<span><span class="co">#&gt; ROIs analyzed: 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Heterogeneity:</span></span>
<span><span class="co">#&gt;   Mean tau^2: 0 </span></span>
<span><span class="co">#&gt;   Mean I^2: NaN %</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "fmri_meta_contrast"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="a-quick-visualization">A quick visualization<a class="anchor" aria-label="anchor" href="#a-quick-visualization"></a>
</h2>
<p>We can visualize the group effects and their 95% CIs for the
ROI-level fit.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">fit_cov</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">df_tidy</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 10</span></span></span>
<span><span class="co">#&gt;   roi        term     estimate std.error statistic  p.value  tau2    I2 conf.low</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ExampleROI (Interc…      0.5     0.112      4.47 7.74<span style="color: #949494;">e</span><span style="color: #BB0000;">- 6</span>     0    <span style="color: #BB0000;">NA</span>    0.281</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ExampleROI groupB        1       0.158      6.32 2.54<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>     0    <span style="color: #BB0000;">NA</span>    0.690</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: conf.high &lt;dbl&gt;</span></span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df_tidy</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">term</span>, y <span class="op">=</span> <span class="va">estimate</span>, ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"ROI-level group meta-analysis"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Term"</span>, y <span class="op">=</span> <span class="st">"Estimate ± 95% CI"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="group_analysis_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="notes-on-voxelwise-analysis">Notes on voxelwise analysis<a class="anchor" aria-label="anchor" href="#notes-on-voxelwise-analysis"></a>
</h2>
<p>For voxelwise analysis, construct <code>group_data</code> with format
<code>"h5"</code> or <code>"nifti"</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># HDF5 (produced via write_results.fmri_lm)</span></span>
<span><span class="co"># gd_h5 &lt;- group_data(h5_paths, format = "h5",</span></span>
<span><span class="co">#                     subjects = subject_ids,</span></span>
<span><span class="co">#                     contrast = "ContrastName",</span></span>
<span><span class="co">#                     covariates = data.frame(group = group))</span></span>
<span></span>
<span><span class="co"># NIfTI (provide per-subject paths for beta/SE or t)</span></span>
<span><span class="co"># gd_nii &lt;- group_data(list(beta = beta_paths, se = se_paths), format = "nifti",</span></span>
<span><span class="co">#                      subjects = subject_ids,</span></span>
<span><span class="co">#                      mask = "group_mask.nii.gz")</span></span>
<span></span>
<span><span class="co"># fit &lt;- fmri_meta(gd_h5, formula = ~ 1 + group, method = "pm")</span></span>
<span><span class="co"># fit &lt;- fmri_meta(gd_nii, formula = ~ 1, method = "fe")</span></span></code></pre></div>
<p>For multiple comparisons correction that leverages spatial structure,
see <code><a href="../reference/spatial_fdr.html">spatial_fdr()</a></code> and <code><a href="../reference/create_3d_blocks.html">create_3d_blocks()</a></code>.</p>
<div class="section level3">
<h3 id="minimal-nifti-example-reproducible">Minimal NIfTI Example (Reproducible)<a class="anchor" aria-label="anchor" href="#minimal-nifti-example-reproducible"></a>
</h3>
<p>This chunk creates tiny synthetic NIfTI volumes on disk (in a temp
dir) for a voxelwise demonstration. Group B has a higher effect in a
small cube.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/neuroim2" class="external-link">neuroim2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">tmpdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">space</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroSpace.html" class="external-link">NeuroSpace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span>, spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_per_group</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"sub-%02d"</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n_per_group</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n_per_group</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a small active cube: x=3:5, y=3:5, z=3:5</span></span>
<span><span class="va">active</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">FALSE</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">active</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="va">beta_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">se_paths</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Baseline effect in active region</span></span>
<span>  <span class="va">b</span><span class="op">[</span><span class="va">active</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">grp</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">)</span> <span class="fl">0.5</span> <span class="kw">else</span> <span class="fl">1.5</span></span>
<span>  <span class="co"># Small random noise per voxel (optional)</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="va">b</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">v_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroVol.html" class="external-link">NeuroVol</a></span><span class="op">(</span><span class="va">b</span>, <span class="va">space</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Constant SE per voxel</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.25</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">v_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroVol.html" class="external-link">NeuroVol</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">space</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">beta_paths</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s_beta.nii.gz"</span>, <span class="va">ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">se_paths</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s_se.nii.gz"</span>, <span class="va">ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/write_vol-methods.html" class="external-link">write_vol</a></span><span class="op">(</span><span class="va">v_beta</span>, <span class="va">beta_paths</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/write_vol-methods.html" class="external-link">write_vol</a></span><span class="op">(</span><span class="va">v_se</span>,   <span class="va">se_paths</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Mask covers all voxels</span></span>
<span><span class="va">mask_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"mask.nii.gz"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/write_vol-methods.html" class="external-link">write_vol</a></span><span class="op">(</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroVol.html" class="external-link">NeuroVol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span>, <span class="va">space</span><span class="op">)</span>, <span class="va">mask_path</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build group_data and fit voxelwise meta-analysis</span></span>
<span><span class="va">gd_nii</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group_data_from_nifti.html">group_data_from_nifti</a></span><span class="op">(</span></span>
<span>  beta_paths <span class="op">=</span> <span class="va">beta_paths</span>,</span>
<span>  se_paths   <span class="op">=</span> <span class="va">se_paths</span>,</span>
<span>  subjects   <span class="op">=</span> <span class="va">ids</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">grp</span><span class="op">)</span>,</span>
<span>  mask       <span class="op">=</span> <span class="va">mask_path</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_nii</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd_nii</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">group</span>, method <span class="op">=</span> <span class="st">"fe"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">fit_nii</span></span>
<span><span class="co">#&gt; fMRI Meta-Analysis Results</span></span>
<span><span class="co">#&gt; ==========================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: fe </span></span>
<span><span class="co">#&gt; Robust: none </span></span>
<span><span class="co">#&gt; Formula: ~1 + group </span></span>
<span><span class="co">#&gt; Subjects: 6 </span></span>
<span><span class="co">#&gt; Voxels analyzed: 512 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Heterogeneity:</span></span>
<span><span class="co">#&gt;   Mean tau^2: 0 </span></span>
<span><span class="co">#&gt;   Mean I^2: 0 %</span></span>
<span></span>
<span><span class="co"># Get p-values for the group term and count discoveries (uncorrected)</span></span>
<span><span class="va">group_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"group"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fit_nii</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pvals</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit_nii</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span>, <span class="va">group_col</span><span class="op">]</span> <span class="op">/</span> <span class="va">fit_nii</span><span class="op">$</span><span class="va">se</span><span class="op">[</span>, <span class="va">group_col</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pvals</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 27</span></span>
<span></span>
<span><span class="co"># Optionally, apply spatial FDR (group term), using simple blocks</span></span>
<span><span class="va">sfr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_fdr.html">spatial_fdr</a></span><span class="op">(</span><span class="va">fit_nii</span>, p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fit_nii</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span><span class="op">[</span><span class="va">group_col</span><span class="op">]</span>, group <span class="op">=</span> <span class="st">"blocks"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sfr</span><span class="op">$</span><span class="va">reject</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 75</span></span>
<span></span>
<span><span class="co"># Reconstruct an image for the group effect estimate</span></span>
<span><span class="va">img_group_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coef_image.html">coef_image</a></span><span class="op">(</span><span class="va">fit_nii</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fit_nii</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span><span class="op">[</span><span class="va">group_col</span><span class="op">]</span>, statistic <span class="op">=</span> <span class="st">"estimate"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">as.array</a></span><span class="op">(</span><span class="va">img_group_est</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -0.09585902  1.08515382</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exact-contrasts-and-stored-covariance">Exact contrasts and stored covariance<a class="anchor" aria-label="anchor" href="#exact-contrasts-and-stored-covariance"></a>
</h3>
<p>You can request exact contrasts at fit-time or store per-voxel
covariance for exact post-hoc contrasts.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Exact post-hoc contrasts by storing packed Var(beta) per voxel</span></span>
<span><span class="va">fit_nii_pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span></span>
<span>  <span class="va">gd_nii</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">group</span>, method <span class="op">=</span> <span class="st">"pm"</span>,</span>
<span>  return_cov <span class="op">=</span> <span class="st">"tri"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Exact post-hoc contrast on the group term</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/contrast.html">contrast</a></span><span class="op">(</span><span class="va">fit_nii_pm</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="fl">0</span>, group <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt;          Length Class     Mode     </span></span>
<span><span class="co">#&gt; estimate 512    -none-    numeric  </span></span>
<span><span class="co">#&gt; se       512    -none-    numeric  </span></span>
<span><span class="co">#&gt; z        512    -none-    numeric  </span></span>
<span><span class="co">#&gt; p        512    -none-    numeric  </span></span>
<span><span class="co">#&gt; weights    2    -none-    numeric  </span></span>
<span><span class="co">#&gt; name       1    -none-    character</span></span>
<span><span class="co">#&gt; parent    17    fmri_meta list</span></span>
<span></span>
<span><span class="co"># Exact fit-time contrast without storing covariance</span></span>
<span><span class="va">fit_nii_con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span></span>
<span>  <span class="va">gd_nii</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">group</span>, method <span class="op">=</span> <span class="st">"pm"</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"group"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fit_nii_pm</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">fit_nii_con</span><span class="op">$</span><span class="va">contrasts</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ names   : chr "group"</span></span>
<span><span class="co">#&gt;  $ estimate: num [1:512, 1] 2.05e-02 1.79e-02 -3.49e-03 -5.51e-02 3.53e-05 ...</span></span>
<span><span class="co">#&gt;  $ se      : num [1:512, 1] 0.204 0.204 0.204 0.204 0.204 ...</span></span>
<span><span class="co">#&gt;  $ z       : num [1:512, 1] 0.100565 0.0878 -0.017112 -0.269929 0.000173 ...</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="two-sample-t-test-welch-and-ols-on-nifti">Two-sample t-test (Welch and OLS) on NIfTI<a class="anchor" aria-label="anchor" href="#two-sample-t-test-welch-and-ols-on-nifti"></a>
</h3>
<p>As an alternative to meta-analysis, we can run two-sample voxelwise
t-tests directly on the per-subject beta maps, using either Welch’s
unequal-variance test or a standard OLS/Student t-test via a simple
design matrix.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Welch and classic OLS via high-level R wrapper</span></span>
<span><span class="va">fit_welch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_ttest.html">fmri_ttest</a></span><span class="op">(</span><span class="va">gd_nii</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">group</span>, engine <span class="op">=</span> <span class="st">"welch"</span><span class="op">)</span></span>
<span><span class="va">t_welch</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fit_welch</span><span class="op">$</span><span class="va">t</span><span class="op">[</span><span class="st">"group"</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">df_welch</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fit_welch</span><span class="op">$</span><span class="va">df</span><span class="op">[</span><span class="st">"group"</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">p_welch</span>   <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">pt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">t_welch</span><span class="op">)</span>, df <span class="op">=</span> <span class="va">df_welch</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_ols</span>   <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_ttest.html">fmri_ttest</a></span><span class="op">(</span><span class="va">gd_nii</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">group</span>, engine <span class="op">=</span> <span class="st">"classic"</span><span class="op">)</span></span>
<span><span class="co"># Prefer named row; fallback to 2nd row if rownames are missing</span></span>
<span><span class="va">rn_t</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit_ols</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">rn_t</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">rn_t</span> <span class="op">==</span> <span class="st">"group"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">t_ols</span> <span class="op">&lt;-</span> <span class="va">fit_ols</span><span class="op">$</span><span class="va">t</span><span class="op">[</span><span class="st">"group"</span>, <span class="op">]</span></span>
<span>  <span class="va">df_ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fit_ols</span><span class="op">$</span><span class="va">df</span><span class="op">[</span><span class="st">"group"</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">t_ols</span> <span class="op">&lt;-</span> <span class="va">fit_ols</span><span class="op">$</span><span class="va">t</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span></span>
<span>  <span class="va">df_ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">fit_ols</span><span class="op">$</span><span class="va">df</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">t_ols</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">p_ols</span>    <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">pt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">t_ols</span><span class="op">)</span>, df <span class="op">=</span> <span class="va">df_ols</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reconstruct quick image for Welch t (using the same mask/space)</span></span>
<span><span class="va">timg_welch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroVol.html" class="external-link">NeuroVol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA_real_</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span>, <span class="va">space</span><span class="op">)</span></span>
<span><span class="va">mask_img</span>   <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">gd_nii</span><span class="op">$</span><span class="va">mask_data</span><span class="op">)</span><span class="op">)</span> <span class="va">gd_nii</span><span class="op">$</span><span class="va">mask_data</span> <span class="kw">else</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/read_vol.html" class="external-link">read_vol</a></span><span class="op">(</span><span class="va">mask_path</span><span class="op">)</span></span>
<span><span class="va">timg_welch</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">as.array</a></span><span class="op">(</span><span class="va">mask_img</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">t_welch</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">as.array</a></span><span class="op">(</span><span class="va">timg_welch</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -81.539233   4.582865</span></span>
<span></span>
<span><span class="co"># Count uncorrected significant voxels at alpha=0.05</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">p_welch</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 46</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">p_ols</span>   <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 51</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="combining-t-statistics-only-stoufferfisherlancaster">Combining t-statistics only (Stouffer/Fisher/Lancaster)<a class="anchor" aria-label="anchor" href="#combining-t-statistics-only-stoufferfisherlancaster"></a>
</h2>
<p>When only per‑subject t‑statistics and degrees‑of‑freedom are
available, you can still carry out group inference without betas/SEs by
setting <code>combine =</code> in <code><a href="../reference/fmri_meta.html">fmri_meta()</a></code> (or in
<code>fmri_ttest(..., engine = "meta")</code>). Stouffer combines signed
z‑scores and supports equal, inverse‑variance or custom weights; Fisher
combines p‑values with equal weights; and Lancaster provides a weighted
Fisher variant by mapping weights to per‑subject degrees‑of‑freedom.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Derive per-subject t images from the synthetic beta/SE example</span></span>
<span><span class="va">dat_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_nifti_full.html">read_nifti_full</a></span><span class="op">(</span><span class="va">gd_nii</span><span class="op">)</span></span>
<span><span class="va">tmat</span> <span class="op">&lt;-</span> <span class="va">dat_full</span><span class="op">$</span><span class="va">beta</span> <span class="op">/</span> <span class="va">dat_full</span><span class="op">$</span><span class="va">se</span>  <span class="co"># S x P</span></span>
<span></span>
<span><span class="co"># Write t images to tempdir for illustration</span></span>
<span><span class="va">t_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroVol.html" class="external-link">NeuroVol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA_real_</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span>, <span class="va">space</span><span class="op">)</span></span>
<span>  <span class="va">img</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">as.array</a></span><span class="op">(</span><span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/read_vol.html" class="external-link">read_vol</a></span><span class="op">(</span><span class="va">mask_path</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tmat</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>  <span class="va">pth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s_t.nii.gz"</span>, <span class="va">ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/write_vol-methods.html" class="external-link">write_vol</a></span><span class="op">(</span><span class="va">img</span>, <span class="va">pth</span><span class="op">)</span></span>
<span>  <span class="va">t_paths</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pth</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">gd_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group_data_from_nifti.html">group_data_from_nifti</a></span><span class="op">(</span></span>
<span>  t_paths <span class="op">=</span> <span class="va">t_paths</span>,</span>
<span>  df <span class="op">=</span> <span class="fl">60</span>,  <span class="co"># scalar df replicated per subject for demo</span></span>
<span>  subjects <span class="op">=</span> <span class="va">ids</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">grp</span><span class="op">)</span>,</span>
<span>  mask <span class="op">=</span> <span class="va">mask_path</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Equal-weight Stouffer</span></span>
<span><span class="va">fit_st</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd_t</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, combine <span class="op">=</span> <span class="st">"stouffer"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Weighted Stouffer using custom subject weights (e.g., sample size)</span></span>
<span><span class="va">w_subj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_st_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd_t</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, combine <span class="op">=</span> <span class="st">"stouffer"</span>,</span>
<span>                      weights <span class="op">=</span> <span class="st">"custom"</span>, weights_custom <span class="op">=</span> <span class="va">w_subj</span>,</span>
<span>                      verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fisher (equal weights) and Lancaster (weighted Fisher)</span></span>
<span><span class="va">fit_fi</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd_t</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, combine <span class="op">=</span> <span class="st">"fisher"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">fit_la</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd_t</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, combine <span class="op">=</span> <span class="st">"lancaster"</span>,</span>
<span>                     weights <span class="op">=</span> <span class="st">"custom"</span>, weights_custom <span class="op">=</span> <span class="va">w_subj</span>,</span>
<span>                     verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="meta-engine-via-fmri_ttest-with-weights">Meta engine via fmri_ttest with weights<a class="anchor" aria-label="anchor" href="#meta-engine-via-fmri_ttest-with-weights"></a>
</h2>
<p>The t-test interface supports the meta engine with equal/custom
weighting.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_tt_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_ttest.html">fmri_ttest</a></span><span class="op">(</span><span class="va">gd_nii</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">group</span>, engine <span class="op">=</span> <span class="st">"meta"</span>,</span>
<span>                          weights <span class="op">=</span> <span class="st">"equal"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Meta engine with custom subject weights (e.g., sample sizes or reliability)</span></span>
<span><span class="va">w_subj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_tt_meta_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_ttest.html">fmri_ttest</a></span><span class="op">(</span><span class="va">gd_nii</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">group</span>, engine <span class="op">=</span> <span class="st">"meta"</span>,</span>
<span>                            weights <span class="op">=</span> <span class="st">"custom"</span>, weights_custom <span class="op">=</span> <span class="va">w_subj</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># t-only combine via fmri_ttest delegation (Lancaster, weighted Fisher)</span></span>
<span><span class="va">fit_tt_la</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_ttest.html">fmri_ttest</a></span><span class="op">(</span><span class="va">gd_t</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, engine <span class="op">=</span> <span class="st">"meta"</span>,</span>
<span>                        combine <span class="op">=</span> <span class="st">"lancaster"</span>, weights <span class="op">=</span> <span class="st">"custom"</span>,</span>
<span>                        weights_custom <span class="op">=</span> <span class="va">w_subj</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="roi-t-only-example-stouffer-and-lancaster">ROI t-only example (Stouffer and Lancaster)<a class="anchor" aria-label="anchor" href="#roi-t-only-example-stouffer-and-lancaster"></a>
</h3>
<p>You can also combine t-statistics at the ROI level from a tabular
CSV. Provide per-subject t and df, then choose a combine method.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roi_t_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  subject <span class="op">=</span> <span class="va">subjects</span>,</span>
<span>  roi <span class="op">=</span> <span class="st">"ExampleROI"</span>,</span>
<span>  t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">subjects</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">2.0</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  df <span class="op">=</span> <span class="fl">40</span>,</span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gd_roi_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group_data_from_csv.html">group_data_from_csv</a></span><span class="op">(</span></span>
<span>  <span class="va">roi_t_df</span>,</span>
<span>  effect_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>t <span class="op">=</span> <span class="st">"t"</span>, df <span class="op">=</span> <span class="st">"df"</span><span class="op">)</span>,</span>
<span>  subject_col <span class="op">=</span> <span class="st">"subject"</span>,</span>
<span>  roi_col <span class="op">=</span> <span class="st">"roi"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Equal-weight Stouffer on ROI t-statistics</span></span>
<span><span class="va">fit_roi_st</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd_roi_t</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, combine <span class="op">=</span> <span class="st">"stouffer"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lancaster (weighted Fisher) with custom weights (e.g., per-subject reliability)</span></span>
<span><span class="va">w_roi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">subjects</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_roi_la</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_meta.html">fmri_meta</a></span><span class="op">(</span><span class="va">gd_roi_t</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, combine <span class="op">=</span> <span class="st">"lancaster"</span>,</span>
<span>                        weights <span class="op">=</span> <span class="st">"custom"</span>, weights_custom <span class="op">=</span> <span class="va">w_roi</span>,</span>
<span>                        verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_roi_st</span><span class="op">$</span><span class="va">method</span>, <span class="va">fit_roi_la</span><span class="op">$</span><span class="va">method</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "pm" "pm"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="a-brief-recap">A brief recap<a class="anchor" aria-label="anchor" href="#a-brief-recap"></a>
</h2>
<p>Meta‑analysis in fmrireg supports fixed‑effects and several
random‑effects estimators (<code>method = "fe"|"pm"|"dl"|"reml"</code>),
with optional robust Huber weighting. You can pass subject‑level
covariates for group comparisons and, when working from t‑maps only, set
<code>combine =</code> to use Stouffer, Fisher, or Lancaster. Exact
contrasts are available either at fit‑time (via <code>contrasts=</code>)
or post‑hoc by saving packed covariance with
<code>return_cov = "tri"</code> and then calling
<code><a href="../reference/contrast.html">contrast()</a></code>. Weighting applies to both meta‑regression and
t‑only combinations (<code>weights = "ivw"|"equal"|"custom"</code>, with
<code>weights_custom</code> as a vector of length subjects or an S×P
matrix). The examples above show ROI‑based meta‑regression, voxelwise
fits from NIfTI, and t‑only combinations via both
<code><a href="../reference/fmri_meta.html">fmri_meta()</a></code> and
<code>fmri_ttest(..., engine = "meta")</code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/bbuchsbaum" class="external-link">Bradley Buchsbaum</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
