<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title> • fmrireg</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmrireg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><h6 class="dropdown-header" data-toc-skip>Getting Started</h6></li>
    <li><a class="dropdown-item" href="../articles/Overview.html">Package Overview</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced Topics</h6></li>
    <li><a class="dropdown-item" href="../articles/a_05_contrasts.html">Contrasts</a></li>
    <li><a class="dropdown-item" href="../articles/a_08_simulation.html">Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/a_09_linear_model.html">Linear Modeling</a></li>
    <li><a class="dropdown-item" href="../articles/sketched-ar.html">Sketched GLM (SRHT/IHS + Nyström)</a></li>
    <li><a class="dropdown-item" href="../articles/a_10_dataset.html">Dataset Management</a></li>
    <li><a class="dropdown-item" href="../articles/group_analysis.html">Group Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/functional_connectivity.html">Functional Connectivity</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Resources</h6></li>
    <li><a class="dropdown-item" href="../articles/benchmark_datasets.html">Benchmark Datasets</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/bbuchsbaum/fmrireg/releases/tag/v0.1.0">Version 0.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbuchsbaum/fmrireg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1></h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bbuchsbaum/fmrireg/blob/master/vignettes/a_09_linear_model.Rmd" class="external-link"><code>vignettes/a_09_linear_model.Rmd</code></a></small>
      <div class="d-none name"><code>a_09_linear_model.Rmd</code></div>
    </div>

    
    
<p>title: “04. fMRI Linear Model (GLM)” author: “Bradley R. Buchsbaum”
date: “2025-09-24” output: rmarkdown::html_vignette vignette: &gt; % % %
—</p>
<div class="section level2">
<h2 id="introduction-to-fmri-linear-models">Introduction to fMRI Linear Models<a class="anchor" aria-label="anchor" href="#introduction-to-fmri-linear-models"></a>
</h2>
<p>Statistical analysis of fMRI data typically involves fitting a linear
model to each voxel’s time series. This approach, often called the
General Linear Model (GLM), estimates how much each experimental
condition contributes to the observed signal. The <code>fmrireg</code>
package provides a flexible framework for:</p>
<ol style="list-style-type: decimal">
<li>Modeling the hemodynamic response to experimental stimuli</li>
<li>Accounting for baseline trends and noise</li>
<li>Estimating condition-specific effects</li>
<li>Computing contrasts between conditions</li>
<li>Testing statistical hypotheses about brain activity</li>
</ol>
<p>Thread usage in internal routines can be adjusted globally. Set
<code>options(fmrireg.num_threads = &lt;n&gt;)</code> or the environment
variable <code>FMRIREG_NUM_THREADS</code> before loading the package to
control how many threads RcppParallel uses.</p>
<p>This vignette demonstrates how to conduct a complete linear model
analysis using the <code>fmrireg</code> package, from data simulation to
statistical inference.</p>
</div>
<div class="section level2">
<h2 id="simulating-a-dataset-for-analysis">Simulating a Dataset for Analysis<a class="anchor" aria-label="anchor" href="#simulating-a-dataset-for-analysis"></a>
</h2>
<p>First, let’s create a realistic fMRI dataset with known parameters.
We’ll simulate a simple experiment with two conditions that have
different amplitudes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create an experimental design with two conditions</span></span>
<span><span class="co"># Condition 1: 10 events with amplitude 1.0</span></span>
<span><span class="co"># Condition 2: 10 events with amplitude 2.0</span></span>
<span></span>
<span><span class="co"># Define parameters</span></span>
<span><span class="va">TR</span> <span class="op">&lt;-</span> <span class="fl">2</span>                  <span class="co"># Repetition time (2 seconds)</span></span>
<span><span class="va">run_length</span> <span class="op">&lt;-</span> <span class="fl">200</span>        <span class="co"># 200 timepoints per run = 400 seconds</span></span>
<span><span class="va">nruns</span> <span class="op">&lt;-</span> <span class="fl">1</span>               <span class="co"># Number of runs</span></span>
<span></span>
<span><span class="co"># Create an event table</span></span>
<span><span class="va">run_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">condition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"condition1"</span>, <span class="st">"condition2"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">onset_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">20</span>, min <span class="op">=</span> <span class="fl">10</span>, max <span class="op">=</span> <span class="fl">380</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Random onsets between 10s and 380s</span></span>
<span></span>
<span><span class="va">event_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  run <span class="op">=</span> <span class="va">run_id</span>,</span>
<span>  onset <span class="op">=</span> <span class="va">onset_times</span>,</span>
<span>  condition <span class="op">=</span> <span class="va">condition</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display the experiment design</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">event_table</span><span class="op">)</span>, caption <span class="op">=</span> <span class="st">"First few rows of the experimental design"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>First few rows of the experimental design</caption>
<thead><tr class="header">
<th align="right">run</th>
<th align="right">onset</th>
<th align="left">condition</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">53.47032</td>
<td align="left">condition1</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">59.82664</td>
<td align="left">condition1</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">104.50866</td>
<td align="left">condition1</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">115.87163</td>
<td align="left">condition1</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">179.36446</td>
<td align="left">condition1</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">181.04834</td>
<td align="left">condition1</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a sampling frame</span></span>
<span><span class="va">sframe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="va">run_length</span>, TR <span class="op">=</span> <span class="va">TR</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize the experimental design</span></span>
<span><span class="va">event_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">(</span><span class="va">run_length</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">TR</span>, by <span class="op">=</span> <span class="va">TR</span><span class="op">)</span>,</span>
<span>  condition1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">run_length</span><span class="op">)</span>,</span>
<span>  condition2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">run_length</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mark event onsets in the timeline</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">event_table</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">timepoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">event_df</span><span class="op">$</span><span class="va">time</span> <span class="op">-</span> <span class="va">event_table</span><span class="op">$</span><span class="va">onset</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">event_table</span><span class="op">$</span><span class="va">condition</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="st">"condition1"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">event_df</span><span class="op">$</span><span class="va">condition1</span><span class="op">[</span><span class="va">timepoint</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">event_df</span><span class="op">$</span><span class="va">condition2</span><span class="op">[</span><span class="va">timepoint</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Convert to long format for plotting</span></span>
<span><span class="va">event_long</span> <span class="op">&lt;-</span> <span class="va">event_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">time</span>, names_to <span class="op">=</span> <span class="st">"condition"</span>, values_to <span class="op">=</span> <span class="st">"onset"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the experimental design</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">event_long</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">onset</span>, color <span class="op">=</span> <span class="va">condition</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_segment</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xend <span class="op">=</span> <span class="va">time</span>, yend <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>        text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Experimental Design with Event Onsets"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Time (seconds)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Event"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a_09_linear_model_files/figure-html/unnamed-chunk-2-1.png" alt="Figure illustrating model, design, or results; see caption and text for details." width="672"></p>
<p>Now that we have our experimental design, let’s simulate the fMRI
time series. We’ll create signals for each condition with different
amplitudes, add noise, and combine them into a dataset.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate the true BOLD signals for each condition</span></span>
<span><span class="co"># First, convert our events to global indices</span></span>
<span><span class="va">global_onsets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/global_onsets.html" class="external-link">global_onsets</a></span><span class="op">(</span><span class="va">sframe</span>, <span class="va">event_table</span><span class="op">$</span><span class="va">onset</span>, <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/blockids.html" class="external-link">blockids</a></span><span class="op">(</span><span class="va">sframe</span><span class="op">)</span><span class="op">[</span><span class="va">event_table</span><span class="op">$</span><span class="va">run</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create regressors for each condition</span></span>
<span><span class="va">condition1_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">event_table</span><span class="op">$</span><span class="va">condition</span> <span class="op">==</span> <span class="st">"condition1"</span><span class="op">)</span></span>
<span><span class="va">condition2_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">event_table</span><span class="op">$</span><span class="va">condition</span> <span class="op">==</span> <span class="st">"condition2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/regressor.html" class="external-link">regressor</a></span><span class="op">(</span><span class="va">global_onsets</span><span class="op">[</span><span class="va">condition1_indices</span><span class="op">]</span>, hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>, amplitude <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span></span>
<span><span class="va">reg2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/regressor.html" class="external-link">regressor</a></span><span class="op">(</span><span class="va">global_onsets</span><span class="op">[</span><span class="va">condition2_indices</span><span class="op">]</span>, hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>, amplitude <span class="op">=</span> <span class="fl">2.0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample time points</span></span>
<span><span class="va">time_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/samples.html" class="external-link">samples</a></span><span class="op">(</span><span class="va">sframe</span>, global <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Evaluate regressors at each time point</span></span>
<span><span class="va">signal1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span><span class="va">reg1</span>, <span class="va">time_points</span><span class="op">)</span></span>
<span><span class="va">signal2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span><span class="va">reg2</span>, <span class="va">time_points</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine signals (this is the "true" signal without noise)</span></span>
<span><span class="va">true_signal</span> <span class="op">&lt;-</span> <span class="va">signal1</span> <span class="op">+</span> <span class="va">signal2</span></span>
<span></span>
<span><span class="co"># Create noise with temporal autocorrelation and drift</span></span>
<span><span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_noise_vector.html">simulate_noise_vector</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time_points</span><span class="op">)</span>,</span>
<span>  TR <span class="op">=</span> <span class="va">TR</span>,</span>
<span>  ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span>,         <span class="co"># Stronger AR(1) coefficient to accentuate autocorrelation</span></span>
<span>  ma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,     <span class="co"># Pure AR structure keeps the example simple</span></span>
<span>  drift_freq <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">128</span>,  <span class="co"># Slow drift</span></span>
<span>  drift_amplitude <span class="op">=</span> <span class="fl">1</span>, <span class="co"># Moderate drift amplitude</span></span>
<span>  physio <span class="op">=</span> <span class="cn">TRUE</span>,       <span class="co"># Include physiological noise</span></span>
<span>  sd <span class="op">=</span> <span class="fl">0.5</span>             <span class="co"># Noise standard deviation</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the observed signal by adding noise</span></span>
<span><span class="va">observed_signal</span> <span class="op">&lt;-</span> <span class="va">true_signal</span> <span class="op">+</span> <span class="va">noise</span></span>
<span></span>
<span><span class="co"># Create a data frame for visualization</span></span>
<span><span class="va">signal_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="va">time_points</span>,</span>
<span>  true_signal <span class="op">=</span> <span class="va">true_signal</span>,</span>
<span>  noise <span class="op">=</span> <span class="va">noise</span>,</span>
<span>  observed_signal <span class="op">=</span> <span class="va">observed_signal</span>,</span>
<span>  condition1 <span class="op">=</span> <span class="va">signal1</span>,</span>
<span>  condition2 <span class="op">=</span> <span class="va">signal2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a matrix dataset for the model fitting</span></span>
<span><span class="va">simulated_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">observed_signal</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu">fmridataset</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmridataset/reference/matrix_dataset.html" class="external-link">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">simulated_data</span>, <span class="va">simulated_data</span> <span class="op">*</span> <span class="fl">0.8</span>, <span class="va">simulated_data</span> <span class="op">*</span> <span class="fl">0.6</span><span class="op">)</span>, <span class="co"># Three "voxels" with varied signal strength</span></span>
<span>  TR <span class="op">=</span> <span class="va">TR</span>,</span>
<span>  run_length <span class="op">=</span> <span class="va">run_length</span>,</span>
<span>  event_table <span class="op">=</span> <span class="va">event_table</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize the signals</span></span>
<span><span class="va">signal_long</span> <span class="op">&lt;-</span> <span class="va">signal_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">time</span>, <span class="va">condition1</span>, <span class="va">condition2</span>, <span class="va">true_signal</span>, <span class="va">noise</span>, <span class="va">observed_signal</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">time</span>, names_to <span class="op">=</span> <span class="st">"component"</span>, values_to <span class="op">=</span> <span class="st">"signal"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the factor levels for better plotting order</span></span>
<span><span class="va">signal_long</span><span class="op">$</span><span class="va">component</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">signal_long</span><span class="op">$</span><span class="va">component</span>, </span>
<span>                               levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"condition1"</span>, <span class="st">"condition2"</span>, <span class="st">"true_signal"</span>, <span class="st">"noise"</span>, <span class="st">"observed_signal"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot signals</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">signal_long</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">signal</span>, color <span class="op">=</span> <span class="va">component</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">component</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>        text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Simulated fMRI Time Series Components"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Time (seconds)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Signal Amplitude"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a_09_linear_model_files/figure-html/unnamed-chunk-3-1.png" alt="Figure illustrating model, design, or results; see caption and text for details." width="672"></p>
<p>Our simulated dataset now contains:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Condition-specific signals</strong> with known amplitudes
(1.0 and 2.0)</li>
<li>
<strong>Realistic noise</strong> with temporal autocorrelation,
drift, and physiological components</li>
<li>
<strong>Multiple “voxels”</strong> with varying signal
strengths</li>
<li>
<strong>A complete event table</strong> with condition labels and
onset times</li>
</ol>
</div>
<div class="section level2">
<h2 id="fitting-a-linear-model">Fitting a Linear Model<a class="anchor" aria-label="anchor" href="#fitting-a-linear-model"></a>
</h2>
<p>Now we can fit a linear model to our simulated data using the
<code>fmri_lm</code> function. We need to specify:</p>
<ol style="list-style-type: decimal">
<li>The formula describing the experimental effects</li>
<li>The block structure of the data</li>
<li>The dataset</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit a linear model</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_lm.html">fmri_lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">onset</span> <span class="op">~</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/hrf.html" class="external-link">hrf</a></span><span class="op">(</span><span class="va">condition</span><span class="op">)</span>,  <span class="co"># Model experimental effects</span></span>
<span>  block <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,                     <span class="co"># Block structure</span></span>
<span>  dataset <span class="op">=</span> <span class="va">dataset</span>,                 <span class="co"># Our simulated dataset</span></span>
<span>  strategy <span class="op">=</span> <span class="st">"chunkwise"</span>,            <span class="co"># Processing strategy</span></span>
<span>  nchunks <span class="op">=</span> <span class="fl">1</span>                        <span class="co"># Process all voxels at once</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print a summary of the model</span></span>
<span><span class="va">model</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">## ==================================</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">##         fmri_lm_result          </span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">## ==================================</span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">## </span></span></span>
<span><span class="co"><span style="color: #0000BB; font-weight: bold;">## </span><span style="color: #00BB00;">Model formula:</span></span></span>
<span><span class="co"><span style="color: #00BB00;">##   </span><span style="color: #555555;">~</span> <span style="color: #555555;">onset</span> <span style="color: #555555;">hrf(condition)</span> </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #00BB00;">Fitting strategy:  </span><span style="color: #555555;">chunkwise</span> </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #00BB00;">Baseline parameters: </span> <span style="color: #555555;">4</span> </span></span>
<span><span class="co">## <span style="color: #00BB00;">Design parameters:   </span> <span style="color: #555555;">2</span> </span></span>
<span><span class="co">## <span style="color: #00BB00;">Contrasts:          </span> <span style="color: #555555;">None</span></span></span>
<span><span class="co"><span style="color: #555555;">## </span></span></span>
<span><span class="co"><span style="color: #555555;">## </span><span style="color: #BBBB00;">Use coef(...), stats(...), etc. to extract results.</span></span></span>
<span><span class="co"><span style="color: #BBBB00;">## </span></span></span>
<span><span class="co"><span style="color: #BBBB00;">## </span></span></span></code></pre>
<div class="section level3">
<h3 id="accounting-for-temporal-autocorrelation">Accounting for Temporal Autocorrelation<a class="anchor" aria-label="anchor" href="#accounting-for-temporal-autocorrelation"></a>
</h3>
<p>The simulated noise contains AR(1) structure. We can ask
<code>fmri_lm</code> to apply a fast AR(1) prewhitening step by setting
<code>cor_struct = "ar1"</code>. This estimates the AR coefficient from
an initial OLS fit, whitens the data and design matrix, and refits the
GLM.</p>
<p>With stronger temporal autocorrelation in the simulated noise, the
prewhitened model recovers tighter standard errors than OLS.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_ar1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_lm.html">fmri_lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">onset</span> <span class="op">~</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/hrf.html" class="external-link">hrf</a></span><span class="op">(</span><span class="va">condition</span><span class="op">)</span>,</span>
<span>  block   <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  dataset <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  strategy <span class="op">=</span> <span class="st">"chunkwise"</span>,</span>
<span>  nchunks <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  cor_struct <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>  cor_iter <span class="op">=</span> <span class="fl">2</span>              <span class="co"># Iterate to refine the AR(1) estimate</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare standard errors (first few voxels)</span></span>
<span><span class="va">se_ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standard_error.html">standard_error</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="va">se_ar1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standard_error.html">standard_error</a></span><span class="op">(</span><span class="va">model_ar1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>OLS <span class="op">=</span> <span class="va">se_ols</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, AR1 <span class="op">=</span> <span class="va">se_ar1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         OLS    AR1</span></span>
<span><span class="co">## [1,] 0.1170 0.0943</span></span>
<span><span class="co">## [2,] 0.0936 0.0604</span></span>
<span><span class="co">## [3,] 0.0702 0.0340</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inspect the estimated AR coefficient (shared across voxels in this example)</span></span>
<span><span class="va">model_ar1</span><span class="op">$</span><span class="va">ar_coef</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] 0.7065745</span></span></code></pre>
<p>The AR(1) model now estimates a non-zero autoregressive coefficient
and produces notably smaller standard errors than the plain OLS fit,
illustrating how prewhitening improves efficiency when temporal
autocorrelation is present.</p>
<p>The <code>cor_struct</code> argument also accepts <code>"arp"</code>
for higher-order autoregressive models. This setting models AR
coefficients only (no moving-average terms).</p>
</div>
<div class="section level3">
<h3 id="handling-outliers-with-row-wise-robust-fitting">Handling Outliers with Row-Wise Robust Fitting<a class="anchor" aria-label="anchor" href="#handling-outliers-with-row-wise-robust-fitting"></a>
</h3>
<p>Real fMRI runs sometimes contain entire time points corrupted by
motion or scanner artifacts. The <code>fmri_lm</code> function can
mitigate their impact by enabling row-wise robust weighting. When
<code>robust = TRUE</code>, an Iteratively Reweighted Least Squares loop
down-weights frames with large residuals. The <code>robust_psi</code>
argument selects the weighting function and <code>robust_max_iter</code>
controls the number of iterations.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_robust</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_lm.html">fmri_lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">onset</span> <span class="op">~</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/hrf.html" class="external-link">hrf</a></span><span class="op">(</span><span class="va">condition</span><span class="op">)</span>,</span>
<span>  block   <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  dataset <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  strategy <span class="op">=</span> <span class="st">"chunkwise"</span>,</span>
<span>  nchunks <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  robust <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  robust_psi <span class="op">=</span> <span class="st">"huber"</span>,</span>
<span>  robust_max_iter <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">se_robust</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standard_error.html">standard_error</a></span><span class="op">(</span><span class="va">model_robust</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>OLS <span class="op">=</span> <span class="va">se_ols</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, Robust <span class="op">=</span> <span class="va">se_robust</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             OLS     Robust</span></span>
<span><span class="co">## [1,] 0.11701370 0.06946794</span></span>
<span><span class="co">## [2,] 0.09361096 0.06946794</span></span>
<span><span class="co">## [3,] 0.07020822 0.06946794</span></span></code></pre>
<p>Robust fitting guards against outlier time points but will not
correct voxel-specific spikes. In this simulated example the Huber
weights inflate the standard errors slightly, reflecting the additional
uncertainty introduced by potential outliers. P-values rely on a robust
residual scale and should be interpreted as approximate.</p>
</div>
</div>
<div class="section level2">
<h2 id="extracting-model-results">Extracting Model Results<a class="anchor" aria-label="anchor" href="#extracting-model-results"></a>
</h2>
<p>Let’s extract and visualize the results from our linear model.</p>
<div class="section level3">
<h3 id="coefficient-estimates">1. Coefficient Estimates<a class="anchor" aria-label="anchor" href="#coefficient-estimates"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract coefficient estimates</span></span>
<span><span class="va">beta_estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">beta_estimates</span>, caption <span class="op">=</span> <span class="st">"Coefficient estimates for each condition and voxel"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Coefficient estimates for each condition and voxel</caption>
<tbody>
<tr class="odd">
<td align="left">condition_condition.condition1</td>
<td align="right">0.6482899</td>
<td align="right">0.5186319</td>
<td align="right">0.3889739</td>
</tr>
<tr class="even">
<td align="left">condition_condition.condition2</td>
<td align="right">1.8880917</td>
<td align="right">1.5104734</td>
<td align="right">1.1328550</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Helper to clean condition column labels for readability</span></span>
<span><span class="va">clean_condition_label</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^conditioncondition_condition\\."</span>, <span class="st">""</span>, <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^condition_condition\\."</span>, <span class="st">""</span>, <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\."</span>, <span class="st">" "</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Reshape for plotting (works with both approaches)</span></span>
<span><span class="va">beta_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_estimates</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>voxel_index <span class="op">=</span> <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">voxel_index</span>, names_to <span class="op">=</span> <span class="st">"condition"</span>, values_to <span class="op">=</span> <span class="st">"estimate"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    condition <span class="op">=</span> <span class="fu">clean_condition_label</span><span class="op">(</span><span class="va">condition</span><span class="op">)</span>,</span>
<span>    voxel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"voxel"</span>, <span class="va">voxel_index</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot coefficient estimates</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">beta_long</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">condition</span>, y <span class="op">=</span> <span class="va">estimate</span>, fill <span class="op">=</span> <span class="va">condition</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">voxel</span>, ncol <span class="op">=</span> <span class="fl">3</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>        text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Estimated Coefficients by Condition and Voxel"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Condition"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Coefficient Estimate"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a_09_linear_model_files/figure-html/unnamed-chunk-8-1.png" alt="Figure illustrating model, design, or results; see caption and text for details." width="672"></p>
<p>The bar plot shows the estimated coefficients for each condition
across the three simulated voxels. Note that:</p>
<ul>
<li>Condition2 has approximately twice the amplitude of Condition1,
which matches our simulation parameters</li>
<li>The coefficient magnitude decreases across voxels, consistent with
our multiplication factors (1.0, 0.8, 0.6)</li>
</ul>
</div>
<div class="section level3">
<h3 id="t-statistics-and-p-values">2. T-Statistics and P-Values<a class="anchor" aria-label="anchor" href="#t-statistics-and-p-values"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimate_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">model</span>, type <span class="op">=</span> <span class="st">"estimates"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"condition"</span>, <span class="va">term</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>condition <span class="op">=</span> <span class="fu">clean_condition_label</span><span class="op">(</span><span class="va">term</span><span class="op">)</span>,</span>
<span>         voxel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"voxel"</span>, <span class="va">voxel</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">voxel</span>, <span class="va">condition</span>, <span class="va">estimate</span>, <span class="va">std_error</span>, <span class="va">statistic</span>, <span class="va">p_value</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">estimate_stats</span>, digits <span class="op">=</span> <span class="fl">4</span>,</span>
<span>      caption <span class="op">=</span> <span class="st">"Coefficient estimates with associated statistics by voxel and condition"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Coefficient estimates with associated statistics by voxel and
condition</caption>
<thead><tr class="header">
<th align="left">voxel</th>
<th align="left">condition</th>
<th align="right">estimate</th>
<th align="right">std_error</th>
<th align="right">statistic</th>
<th align="right">p_value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">voxel1</td>
<td align="left">condition1</td>
<td align="right">0.6483</td>
<td align="right">0.1170</td>
<td align="right">5.5403</td>
<td align="right">0.0000</td>
</tr>
<tr class="even">
<td align="left">voxel1</td>
<td align="left">condition2</td>
<td align="right">0.5186</td>
<td align="right">0.0936</td>
<td align="right">5.5403</td>
<td align="right">0.0000</td>
</tr>
<tr class="odd">
<td align="left">voxel2</td>
<td align="left">condition1</td>
<td align="right">-0.5550</td>
<td align="right">0.7480</td>
<td align="right">-0.7420</td>
<td align="right">0.4590</td>
</tr>
<tr class="even">
<td align="left">voxel2</td>
<td align="left">condition2</td>
<td align="right">-0.4440</td>
<td align="right">0.5984</td>
<td align="right">-0.7420</td>
<td align="right">0.4590</td>
</tr>
<tr class="odd">
<td align="left">voxel3</td>
<td align="left">condition1</td>
<td align="right">-0.7525</td>
<td align="right">0.3992</td>
<td align="right">-1.8851</td>
<td align="right">0.0609</td>
</tr>
<tr class="even">
<td align="left">voxel3</td>
<td align="left">condition2</td>
<td align="right">-0.6020</td>
<td align="right">0.3193</td>
<td align="right">-1.8851</td>
<td align="right">0.0609</td>
</tr>
</tbody>
</table>
<p>The t-statistics quantify the reliability of the estimated effects.
Higher absolute t-values indicate more reliable estimates. In our
simulation, all conditions in all voxels show significant activity (p
&lt; 0.05).</p>
</div>
<div class="section level3">
<h3 id="contrasts-between-conditions">3. Contrasts Between Conditions<a class="anchor" aria-label="anchor" href="#contrasts-between-conditions"></a>
</h3>
<p>A key advantage of the GLM approach is the ability to directly
compare conditions using contrasts.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a contrast specification for comparing condition2 vs condition1</span></span>
<span><span class="va">con_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/pair_contrast.html" class="external-link">pair_contrast</a></span><span class="op">(</span><span class="op">~</span> <span class="va">condition</span> <span class="op">==</span> <span class="st">"condition2"</span>, <span class="op">~</span> <span class="va">condition</span> <span class="op">==</span> <span class="st">"condition1"</span>, name <span class="op">=</span> <span class="st">"cond2_minus_cond1"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a contrast model using the specified contrast in hrf()</span></span>
<span><span class="va">contrast_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_lm.html">fmri_lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">onset</span> <span class="op">~</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/hrf.html" class="external-link">hrf</a></span><span class="op">(</span><span class="va">condition</span>, contrasts <span class="op">=</span> <span class="va">con_spec</span><span class="op">)</span>,</span>
<span>  block <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  dataset <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  strategy <span class="op">=</span> <span class="st">"chunkwise"</span>,</span>
<span>  nchunks <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract contrast results using tidy helper</span></span>
<span><span class="va">contrast_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">contrast_model</span>, type <span class="op">=</span> <span class="st">"contrasts"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"cond2_minus_cond1"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    voxel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"voxel"</span>, <span class="va">voxel</span><span class="op">)</span>,</span>
<span>    significant <span class="op">=</span> <span class="va">p_value</span> <span class="op">&lt;</span> <span class="fl">0.05</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Display contrast results</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">contrast_results</span>, caption <span class="op">=</span> <span class="st">"Contrast results: condition2 - condition1"</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Contrast results: condition2 - condition1</caption>
<colgroup>
<col width="8%">
<col width="20%">
<col width="10%">
<col width="11%">
<col width="11%">
<col width="9%">
<col width="13%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="left">voxel</th>
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std_error</th>
<th align="right">statistic</th>
<th align="right">p_value</th>
<th align="right">df_residual</th>
<th align="left">significant</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">voxel1</td>
<td align="left">cond2_minus_cond1</td>
<td align="right">1.2398</td>
<td align="right">0.1553</td>
<td align="right">7.9826</td>
<td align="right">0</td>
<td align="right">194</td>
<td align="left">TRUE</td>
</tr>
<tr class="even">
<td align="left">voxel2</td>
<td align="left">cond2_minus_cond1</td>
<td align="right">0.9918</td>
<td align="right">0.1243</td>
<td align="right">7.9826</td>
<td align="right">0</td>
<td align="right">194</td>
<td align="left">TRUE</td>
</tr>
<tr class="odd">
<td align="left">voxel3</td>
<td align="left">cond2_minus_cond1</td>
<td align="right">0.7439</td>
<td align="right">0.0932</td>
<td align="right">7.9826</td>
<td align="right">0</td>
<td align="right">194</td>
<td align="left">TRUE</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize the contrast</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">contrast_results</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">voxel</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">estimate</span>, fill <span class="op">=</span> <span class="va">significant</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Condition2 - Condition1 Contrast"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Positive values indicate stronger activation for Condition2"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Voxel"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Contrast Estimate"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"gray"</span>, <span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a_09_linear_model_files/figure-html/unnamed-chunk-11-1.png" alt="Figure illustrating model, design, or results; see caption and text for details." width="672"></p>
<p>The contrast results show that Condition2 consistently elicits
significantly stronger activation than Condition1 across all voxels,
which matches our simulation parameters (where Condition2 had twice the
amplitude of Condition1).</p>
</div>
</div>
<div class="section level2">
<h2 id="fitted-hrf-curves">Fitted HRF Curves<a class="anchor" aria-label="anchor" href="#fitted-hrf-curves"></a>
</h2>
<p>Another useful visualization is the fitted hemodynamic response for
each condition. This shows the estimated BOLD response over time.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract fitted HRF curves from the fitted model</span></span>
<span><span class="va">fitted_hrfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitted_hrf.html">fitted_hrf</a></span><span class="op">(</span><span class="va">model</span>, sample_at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, by <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract the design info and reorganize for plotting</span></span>
<span><span class="va">hrf_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fitted_hrfs</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">hrf_info</span> <span class="op">&lt;-</span> <span class="va">fitted_hrfs</span><span class="op">[[</span><span class="va">term</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">design_info</span> <span class="op">&lt;-</span> <span class="va">hrf_info</span><span class="op">$</span><span class="va">design</span></span>
<span>  <span class="va">pred_values</span> <span class="op">&lt;-</span> <span class="va">hrf_info</span><span class="op">$</span><span class="va">pred</span></span>
<span>  </span>
<span>  <span class="co"># Combine with design info</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">design_info</span>, <span class="va">pred_values</span><span class="op">)</span></span>
<span>  <span class="va">result</span><span class="op">$</span><span class="va">term</span> <span class="op">&lt;-</span> <span class="va">term</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine all HRF data</span></span>
<span><span class="va">hrf_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">hrf_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Identify predicted-value columns by excluding known design columns</span></span>
<span><span class="va">design_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fitted_hrfs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">design</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"term"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pred_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">hrf_df</span><span class="op">)</span>, <span class="va">design_cols</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pred_cols</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Fallback: match common default names for matrix columns</span></span>
<span>  <span class="va">pred_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^(V|X)?[0-9]+$|^pred.*$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">hrf_df</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create a data frame in long format for plotting</span></span>
<span><span class="va">hrf_long</span> <span class="op">&lt;-</span> <span class="va">hrf_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="va">pred_cols</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"voxel_id"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"response"</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    voxel_index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^[^0-9]*"</span>, <span class="st">""</span>, <span class="va">voxel_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    voxel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"voxel"</span>, <span class="va">voxel_index</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the fitted HRF curves for each condition and voxel</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">hrf_long</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">response</span>, color <span class="op">=</span> <span class="va">condition</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">voxel</span> <span class="op">~</span> <span class="va">term</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Fitted Hemodynamic Response Functions"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Time (seconds)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"BOLD Response"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Condition"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a_09_linear_model_files/figure-html/unnamed-chunk-12-1.png" alt="Figure illustrating model, design, or results; see caption and text for details." width="672"></p>
<p>The fitted HRF curves show the temporal profile of the BOLD response
for each condition. We can observe:</p>
<ol style="list-style-type: decimal">
<li>The peak response around 5-6 seconds post-stimulus</li>
<li>The stronger response for Condition2 compared to Condition1</li>
<li>The decreasing response amplitude across voxels</li>
</ol>
</div>
<div class="section level2">
<h2 id="comparing-models-with-different-hrf-bases">Comparing Models with Different HRF Bases<a class="anchor" aria-label="anchor" href="#comparing-models-with-different-hrf-bases"></a>
</h2>
<p>The choice of hemodynamic response function can impact model fit.
Let’s compare different HRF options.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit models with different HRF bases</span></span>
<span><span class="va">model_canonical</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_lm.html">fmri_lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">onset</span> <span class="op">~</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/hrf.html" class="external-link">hrf</a></span><span class="op">(</span><span class="va">condition</span>, basis <span class="op">=</span> <span class="st">"spmg1"</span><span class="op">)</span>,</span>
<span>  block <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  dataset <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  strategy <span class="op">=</span> <span class="st">"chunkwise"</span>,</span>
<span>  nchunks <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_gaussian</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_lm.html">fmri_lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">onset</span> <span class="op">~</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/hrf.html" class="external-link">hrf</a></span><span class="op">(</span><span class="va">condition</span>, basis <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span>,</span>
<span>  block <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  dataset <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  strategy <span class="op">=</span> <span class="st">"chunkwise"</span>,</span>
<span>  nchunks <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_bspline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_lm.html">fmri_lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">onset</span> <span class="op">~</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/hrf.html" class="external-link">hrf</a></span><span class="op">(</span><span class="va">condition</span>, basis <span class="op">=</span> <span class="st">"bspline"</span>, nbasis <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  block <span class="op">=</span> <span class="op">~</span> <span class="va">run</span>,</span>
<span>  dataset <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  strategy <span class="op">=</span> <span class="st">"chunkwise"</span>,</span>
<span>  nchunks <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to extract model fit statistics</span></span>
<span><span class="va">extract_model_stats</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">model_name</span>, <span class="va">dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get observed data</span></span>
<span>  <span class="va">observed_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmridataset/reference/get_data_matrix.html" class="external-link">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Get design matrix (ensure it's a numeric matrix)</span></span>
<span>  <span class="va">design_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmridesign/reference/design_matrix.html" class="external-link">design_matrix</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">model</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Get estimated coefficients (include baseline)</span></span>
<span>  <span class="co"># Get all coefficients including baseline</span></span>
<span>  <span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model</span>, include_baseline <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate fitted values</span></span>
<span>  <span class="va">fitted_vals</span> <span class="op">&lt;-</span> <span class="va">design_mat</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">betas</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate residuals</span></span>
<span>  <span class="va">resids</span> <span class="op">&lt;-</span> <span class="va">observed_data</span> <span class="op">-</span> <span class="va">fitted_vals</span></span>
<span>  </span>
<span>  <span class="co"># Calculate sum of squared residuals</span></span>
<span>  <span class="va">ssr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">resids</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate R-squared</span></span>
<span>  <span class="va">tss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">observed_data</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r_squared</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">ssr</span><span class="op">/</span><span class="va">tss</span></span>
<span>  </span>
<span>  <span class="co"># Calculate AIC</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">design_mat</span><span class="op">)</span></span>
<span>  <span class="va">aic</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">ssr</span><span class="op">/</span><span class="va">n</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">p</span></span>
<span>  </span>
<span>  <span class="co"># Return results</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model_name</span>,</span>
<span>    voxel <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span>,</span>
<span>    r_squared <span class="op">=</span> <span class="va">r_squared</span>,</span>
<span>    aic <span class="op">=</span> <span class="va">aic</span>,</span>
<span>    ssr <span class="op">=</span> <span class="va">ssr</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Extract statistics for each model</span></span>
<span><span class="va">stats_canonical</span> <span class="op">&lt;-</span> <span class="fu">extract_model_stats</span><span class="op">(</span><span class="va">model_canonical</span>, <span class="st">"canonical_spm"</span>, <span class="va">dataset</span><span class="op">)</span></span>
<span><span class="va">stats_gaussian</span> <span class="op">&lt;-</span> <span class="fu">extract_model_stats</span><span class="op">(</span><span class="va">model_gaussian</span>, <span class="st">"gaussian"</span>, <span class="va">dataset</span><span class="op">)</span></span>
<span><span class="va">stats_bspline</span> <span class="op">&lt;-</span> <span class="fu">extract_model_stats</span><span class="op">(</span><span class="va">model_bspline</span>, <span class="st">"bspline_n5"</span>, <span class="va">dataset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine results</span></span>
<span><span class="va">model_comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">stats_canonical</span>, <span class="va">stats_gaussian</span>, <span class="va">stats_bspline</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display model comparison</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">model_comparison</span>, caption <span class="op">=</span> <span class="st">"Model comparison statistics"</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Model comparison statistics</caption>
<thead><tr class="header">
<th align="left">model</th>
<th align="right">voxel</th>
<th align="right">r_squared</th>
<th align="right">aic</th>
<th align="right">ssr</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">canonical_spm</td>
<td align="right">1</td>
<td align="right">0.6500</td>
<td align="right">-34.1792</td>
<td align="right">158.7644</td>
</tr>
<tr class="even">
<td align="left">canonical_spm</td>
<td align="right">2</td>
<td align="right">0.6500</td>
<td align="right">-123.4367</td>
<td align="right">101.6092</td>
</tr>
<tr class="odd">
<td align="left">canonical_spm</td>
<td align="right">3</td>
<td align="right">0.6500</td>
<td align="right">-238.5095</td>
<td align="right">57.1552</td>
</tr>
<tr class="even">
<td align="left">gaussian</td>
<td align="right">1</td>
<td align="right">0.5950</td>
<td align="right">-4.9647</td>
<td align="right">183.7349</td>
</tr>
<tr class="odd">
<td align="left">gaussian</td>
<td align="right">2</td>
<td align="right">0.5950</td>
<td align="right">-94.2221</td>
<td align="right">117.5903</td>
</tr>
<tr class="even">
<td align="left">gaussian</td>
<td align="right">3</td>
<td align="right">0.5950</td>
<td align="right">-209.2949</td>
<td align="right">66.1446</td>
</tr>
<tr class="odd">
<td align="left">bspline_n5</td>
<td align="right">1</td>
<td align="right">0.6533</td>
<td align="right">-20.0520</td>
<td align="right">157.2847</td>
</tr>
<tr class="even">
<td align="left">bspline_n5</td>
<td align="right">2</td>
<td align="right">0.6533</td>
<td align="right">-109.3094</td>
<td align="right">100.6622</td>
</tr>
<tr class="odd">
<td align="left">bspline_n5</td>
<td align="right">3</td>
<td align="right">0.6533</td>
<td align="right">-224.3822</td>
<td align="right">56.6225</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reshape for plotting</span></span>
<span><span class="va">model_comparison_long</span> <span class="op">&lt;-</span> <span class="va">model_comparison</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r_squared</span>, <span class="va">aic</span>, <span class="va">ssr</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"metric"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot comparison (separate plots for different metrics)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">model_comparison_long</span>, <span class="va">metric</span> <span class="op">==</span> <span class="st">"r_squared"</span><span class="op">)</span>, </span>
<span>       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">model</span>, y <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">voxel</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Model Comparison: R-Squared"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"HRF Model"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"R-Squared"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a_09_linear_model_files/figure-html/unnamed-chunk-13-1.png" alt="Figure illustrating model, design, or results; see caption and text for details." width="672"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">model_comparison_long</span>, <span class="va">metric</span> <span class="op">==</span> <span class="st">"aic"</span><span class="op">)</span>, </span>
<span>       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">model</span>, y <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">voxel</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Model Comparison: AIC (Lower is Better)"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"HRF Model"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"AIC"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a_09_linear_model_files/figure-html/unnamed-chunk-14-1.png" alt="Figure illustrating model, design, or results; see caption and text for details." width="672"></p>
<p>The model comparison shows:</p>
<ol style="list-style-type: decimal">
<li>
<strong>R-Squared</strong>: The proportion of variance explained by
each model. Higher values indicate better fit.</li>
<li>
<strong>AIC (Akaike Information Criterion)</strong>: A measure of
model quality that balances goodness of fit with model complexity. Lower
values indicate better models.</li>
</ol>
<p>In this case, the canonical (SPM) model actually provides the best
fit according to AIC, showing the lowest AIC values across voxels. This
is an interesting result since we used the same HRF (SPMG1) to generate
our data, confirming that the model selection correctly identifies the
true underlying signal generator. The B-spline model, despite having
more flexibility to capture variations in the signal, is penalized by
AIC for its additional complexity. This demonstrates how model selection
criteria like AIC can help identify the most parsimonious model that
explains the data.</p>
<p>The canonical SPM model performs well due to its accurate
representation of the hemodynamic response shape in our simulated data,
making it the optimal choice for this particular dataset. This
highlights the importance of selecting an appropriate HRF basis function
when analyzing fMRI data.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This vignette demonstrated the complete workflow for fMRI linear
model analysis using the <code>fmrireg</code> package:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Creating/simulating a dataset</strong> with realistic signal
and noise properties</li>
<li>
<strong>Fitting linear models</strong> with different HRF
options</li>
<li>
<strong>Extracting and visualizing model coefficients</strong> and
statistics</li>
<li>
<strong>Computing and testing contrasts</strong> between
conditions</li>
<li>
<strong>Comparing model performance</strong> using goodness-of-fit
metrics</li>
<li>
<strong>Diagnosing model quality</strong> through residual
analysis</li>
</ol>
<p>The <code>fmri_lm</code> function provides a powerful and flexible
framework for analyzing fMRI data, with features for handling temporal
autocorrelation, modeling different HRF shapes, and computing contrasts
between conditions.</p>
<p>For more advanced analyses, you might consider: - Adding nuisance
regressors to model physiological noise, motion, or other confounds -
Using more complex experimental designs with multiple factors -
Implementing spatial smoothing or other preprocessing steps - Extending
the GLM with methods like psychophysiological interactions (PPI) or
finite impulse response (FIR) models</p>
</div>
<div class="section level2">
<h2 id="next">Next<a class="anchor" aria-label="anchor" href="#next"></a>
</h2>
<ul>
<li><a href="/articles/a_05_contrasts.html">Contrasts and Hypothesis
Tests</a></li>
<li><a href="/articles/group_analysis.html">Group Analysis</a></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/bbuchsbaum" class="external-link">Bradley Buchsbaum</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
