---
format:
  typst:
    margin:
      x: 1in
      y: 0.8in
    font-size: 10pt
    columns: 1
execute:
  echo: false
  warning: false
  message: false
params:
  data_file: ""
---

```{r}
suppressPackageStartupMessages({
  library(ggplot2)
  library(tinytable)
})

report_data <- readRDS(params$data_file)

fmt_df <- function(df, digits = 3L) {
  if (!is.data.frame(df) || !nrow(df)) {
    return(df)
  }
  out <- df
  for (nm in names(out)) {
    if (is.numeric(out[[nm]])) {
      out[[nm]] <- round(out[[nm]], digits = digits)
    }
  }
  out
}

as_tt <- function(df, digits = 3L) {
  tinytable::tt(fmt_df(df, digits = digits))
}
```

# `r report_data$meta$title`

```{r}
if (!is.null(report_data$meta$author) && nzchar(report_data$meta$author)) {
  cat(report_data$meta$author, "\n\n")
}
cat("Date:", report_data$meta$date, "\n\n")
cat("fmrireg version:", report_data$meta$package_version, "\n")
```

---

```{r}
if ("model" %in% report_data$sections) {
  cat("## Model Specification\n\n")
  if (!is.null(report_data$model$table) && nrow(report_data$model$table)) {
    as_tt(report_data$model$table, digits = 3L)
  } else {
    cat("No model metadata available.\n")
  }
}
```

```{r}
if ("design" %in% report_data$sections) {
  cat("\n## Design Matrix\n\n")
  d <- report_data$design
  if (isTRUE(d$available) && nrow(d$matrix_long)) {
    print(
      ggplot(d$matrix_long, aes(x = time, y = regressor, fill = value)) +
        geom_raster() +
        scale_fill_gradient2(
          low = "#08306B",
          mid = "#FFFFFF",
          high = "#67000D",
          midpoint = 0
        ) +
        labs(x = "Time index", y = "Regressor", fill = "Value") +
        theme_minimal(base_size = 9)
    )
  } else {
    cat("Design matrix unavailable.\n")
  }

  if (isTRUE(d$available) && nrow(d$corr_long)) {
    cat("\n### Regressor Correlation\n\n")
    print(
      ggplot(d$corr_long, aes(x = x, y = y, fill = corr)) +
        geom_tile() +
        scale_fill_gradient2(
          low = "#2166AC",
          mid = "#FFFFFF",
          high = "#B2182B",
          limits = c(-1, 1)
        ) +
        labs(x = NULL, y = NULL, fill = "r") +
        theme_minimal(base_size = 9) +
        theme(
          axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid = element_blank()
        )
    )
  }
}
```

```{r}
if ("hrf" %in% report_data$sections) {
  cat("\n## HRF Shapes\n\n")
  h <- report_data$hrf
  if (isTRUE(h$available) && nrow(h$data)) {
    print(
      ggplot(h$data, aes(x = time, y = amplitude, color = condition)) +
        geom_line(linewidth = 0.5) +
        facet_wrap(~term, scales = "free_y") +
        labs(x = "Time (s)", y = "Amplitude", color = "Condition") +
        theme_minimal(base_size = 9)
    )
  } else {
    cat("No fitted HRF data available.\n")
  }
}
```

```{r}
if ("estimates" %in% report_data$sections) {
  cat("\n## Parameter Estimates\n\n")
  e <- report_data$estimates
  if (isTRUE(e$available) && nrow(e$table)) {
    as_tt(e$table, digits = 4L)
  } else {
    cat("No estimate summary available.\n")
  }
}
```

```{r}
if ("contrasts" %in% report_data$sections) {
  cat("\n## Contrast Results\n\n")
  cdat <- report_data$contrasts

  if (isTRUE(cdat$available) && length(cdat$items)) {
    regular <- Filter(function(x) !identical(x$type, "Fcontrast"), cdat$items)
    fcons <- Filter(function(x) identical(x$type, "Fcontrast"), cdat$items)

    if (length(regular)) {
      for (item in regular) {
        cat("\n###", item$name, "\n\n")
        as_tt(item$summary, digits = 4L)
        if (is.character(item$map_file) && nzchar(item$map_file) && file.exists(item$map_file)) {
          knitr::include_graphics(item$map_file)
        }
        if (is.data.frame(item$peaks) && nrow(item$peaks)) {
          cat("\nPeak Coordinates\n\n")
          as_tt(item$peaks, digits = 3L)
        } else {
          cat("\nNo supra-threshold peaks found.\n")
        }
      }
    }

    if (length(fcons)) {
      cat("\n### F-Contrasts\n\n")
      for (item in fcons) {
        cat("\n####", item$name, "\n\n")
        as_tt(item$summary, digits = 4L)
        if (is.character(item$map_file) && nzchar(item$map_file) && file.exists(item$map_file)) {
          knitr::include_graphics(item$map_file)
        }
        if (is.data.frame(item$peaks) && nrow(item$peaks)) {
          as_tt(item$peaks, digits = 3L)
        }
      }
    }
  } else {
    cat("No contrasts available.\n")
  }
}
```

```{r}
if ("diagnostics" %in% report_data$sections) {
  cat("\n## Diagnostics\n\n")
  d <- report_data$diagnostics

  if (!is.null(d$ar) && nrow(d$ar)) {
    cat("### AR Parameters\n\n")
    as_tt(d$ar, digits = 4L)
  }

  if (!is.null(d$sigma) && nrow(d$sigma)) {
    cat("\n### Residual Sigma Summary\n\n")
    as_tt(d$sigma, digits = 4L)
  }
}
```

---

Generated by `fmrireg v` `r report_data$meta$package_version` on `r report_data$meta$date`.
