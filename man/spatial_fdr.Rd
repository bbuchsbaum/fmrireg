% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spatial_fdr.R
\name{spatial_fdr}
\alias{spatial_fdr}
\title{Spatially-Aware Multiple Comparisons Correction}
\usage{
spatial_fdr(
  z = NULL,
  p = NULL,
  group = NULL,
  alpha = 0.05,
  tau = 0.5,
  lambda = 1,
  neighbors = NULL,
  min_pi0 = 0.05,
  empirical_null = TRUE,
  verbose = FALSE
)
}
\arguments{
\item{z}{Numeric vector of Z-values (one per feature). Provide either z or p, not both.}

\item{p}{Numeric vector of p-values (two-sided). Provide either z or p, not both.}

\item{group}{Integer or factor vector of group IDs for each feature (e.g., parcel IDs,
block IDs). Must have same length as z or p.}

\item{alpha}{Numeric scalar; FDR level to control (default: 0.05)}

\item{tau}{Numeric scalar; Storey threshold in (0,1) for \eqn{\pi_0} estimation (default: 0.5).
Higher values are more conservative.}

\item{lambda}{Numeric scalar; smoothing strength for groupwise \eqn{\pi_0} across neighbors (default: 1.0).
Set to 0 for no smoothing, higher values for more smoothing.}

\item{neighbors}{Optional list of length G (number of groups) where each element
is an integer vector of 1-based neighbor IDs. Used for spatial smoothing of \eqn{\pi_0}.}

\item{min_pi0}{Numeric scalar; lower bound for \eqn{\pi_0} to stabilize weights (default: 0.05).
Prevents infinite weights.}

\item{empirical_null}{Logical; if TRUE, estimate null distribution parameters (\eqn{\mu_0}, \eqn{\sigma_0})
from central z-values using robust estimators (default: TRUE).}

\item{verbose}{Logical; print progress messages (default: FALSE)}
}
\value{
Object of class "spatial_fdr_result" containing:
\item{reject}{Logical vector indicating rejected hypotheses (discoveries)}
\item{q}{Numeric vector of FDR-adjusted p-values (q-values)}
\item{p}{Numeric vector of two-sided p-values used for testing}
\item{weights}{Numeric vector of normalized weights used in weighted BH}
\item{pi0_raw}{Numeric vector of raw \eqn{\pi_0} estimates per group}
\item{pi0_smooth}{Numeric vector of smoothed \eqn{\pi_0} estimates per group}
\item{threshold}{Numeric scalar; BH threshold used for rejection}
\item{k}{Integer scalar; number of rejections}
\item{mu0}{Numeric scalar; estimated null mean (if empirical_null = TRUE)}
\item{sigma0}{Numeric scalar; estimated null SD (if empirical_null = TRUE)}
\item{groups}{Integer vector of compressed group IDs (1..G)}
\item{group}{Factor or integer vector of original group IDs}
\item{G}{Integer scalar; number of groups}
\item{alpha}{Numeric scalar; FDR level used}
\item{coef_name}{Character scalar; name of coefficient (for S3 method)}
}
\description{
Performs spatially-aware FDR control using structure-adaptive weighted
Benjamini-Hochberg (SABHA-style) procedure. This method leverages spatial
structure in the data to increase power while controlling the false discovery rate.
}
\details{
This function implements a spatially-aware multiple testing procedure that:
\enumerate{
\item Estimates the proportion of null hypotheses (pi0) within spatial groups
\item Optionally smooths these estimates across neighboring groups
\item Uses the pi0 estimates to weight the Benjamini-Hochberg procedure
\item Provides more power in regions with true signal while maintaining FDR control
}

The method is particularly effective for:
\itemize{
\item Voxelwise analyses with spatial clustering of signal
\item Parcel-based analyses with anatomical or functional grouping
\item Any scenario where hypotheses can be grouped spatially or functionally
}
}
\examples{
# Simple synthetic example
set.seed(123)
n <- 1000
z_scores <- c(rnorm(800), rnorm(200, mean = 2))  # 200 true signals
group_ids <- rep(1:10, each = 100)  # 10 groups of 100 features each

# Basic usage without spatial smoothing
result <- spatial_fdr(z = z_scores, group = group_ids, alpha = 0.05)
summary(result)

# Create simple neighbor structure (each group neighbors with adjacent groups)
neighbors <- lapply(1:10, function(i) {
  c(if(i > 1) i-1, if(i < 10) i+1)
})

# With spatial smoothing
result_smooth <- spatial_fdr(z = z_scores, group = group_ids, 
                            neighbors = neighbors, lambda = 1.0)
print(result_smooth)

}
\references{
\itemize{
\item Benjamini & Hochberg (1995). Controlling the false discovery rate.
\item Storey (2002). A direct approach to false discovery rates.
\item Hu et al. (2010). False discovery rate control with groups (SABHA).
}
}
\seealso{
\code{\link{create_3d_blocks}}
}
