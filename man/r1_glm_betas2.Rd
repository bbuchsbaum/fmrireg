% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/rank1_estimation.R
\name{r1_glm_betas2}
\alias{r1_glm_betas2}
\title{Estimate activation coefficients and HRF using Rank-1 GLM}
\usage{
r1_glm_betas2(
  X,
  y,
  Z = NULL,
  hrf_basis,
  hrf_ref,
  maxit = 100,
  flip_sign = FALSE,
  use_box_constraints = FALSE
)
}
\arguments{
\item{X}{Numeric matrix of size \eqn{n \times (k*m)}, where \eqn{n} is the number
of time points, \eqn{k} is the number of conditions, and \eqn{m} is the number
of basis functions. Typically constructed by convolving condition onsets
with HRF basis functions.}

\item{y}{Numeric vector of length \eqn{n} containing the BOLD signal at a single voxel.}

\item{Z}{Optional numeric matrix of nuisance regressors, of size \eqn{n \times q}. Default is NULL.}

\item{hrf_basis}{Numeric matrix of size \eqn{T \times m} with HRF basis functions
(one column per basis function).}

\item{hrf_ref}{Numeric vector of length \eqn{T} representing a reference HRF.}

\item{maxit}{Integer, maximum number of iterations for the optimizer. Default is 100.}

\item{flip_sign}{Logical, whether to enforce positive correlation with \code{hrf_ref}.
If TRUE and the estimated HRF is anti-correlated, it will be sign-flipped together
with the betas. If FALSE, negative deflections are allowed naturally. Default is FALSE.}

\item{use_box_constraints}{Logical, whether to use box constraints on HRF parameters
if \code{m=3}. If TRUE, HRF parameters are constrained to \cdoe{(-1,1)} with \code{h[1]=1}.
This strongly constrains the HRF shape and scale. Default is FALSE.}
}
\value{
A list with elements:
\item{beta}{Numeric vector of length \eqn{k}, the estimated activation coefficients.}
\item{h}{Numeric vector of length \eqn{m}, the estimated HRF coefficients in the chosen basis.}
\item{omega}{Numeric vector of length \eqn{q} with nuisance parameters (if any).}
\item{converged}{Logical indicating whether the optimizer converged.}
\item{value}{Final value of the objective function.}
}
\description{
This function implements the Rank-1 constrained GLM (R1-GLM) for joint
estimation of activation coefficients (betas) and the HRF for a single voxel.
It uses a quasi-Newton approach (L-BFGS-B) for optimization. A Rank-1
constraint enforces a shared HRF across all conditions, while allowing each
condition to have its own amplitude.
}
\details{
This implementation includes:
\itemize{
\item Optional QR decomposition for efficiency when n > p.
\item Optional box constraints for HRF parameters when m=3.
\item An optional sign-flip step to ensure positive correlation with a reference HRF.
\item A small penalty to prevent the HRF from collapsing to a near-zero vector.
}
}
\examples{
# Mock data example:
set.seed(42)
n <- 200; k <- 10; m <- 3; q <- 5
X <- matrix(rnorm(n*k*m), n, k*m)
y <- rnorm(n)
Z <- matrix(rnorm(n*q), n, q)
hrf_basis <- matrix(rnorm(32*m), 32, m)
hrf_ref <- dgamma(seq(0, 31, length.out=32), shape=6, rate=1)

res <- r1_glm_betas(X, y, Z, hrf_basis, hrf_ref, maxit=50, flip_sign=FALSE, use_box_constraints=FALSE)
str(res)

}
\references{
Pedregosa F, Eickenberg M, Ciuciu P, Thirion B, Gramfort A (2015).
Data-driven HRF estimation for encoding and decoding models. NeuroImage 104:209-220.
}
